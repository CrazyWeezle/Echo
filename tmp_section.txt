                                <span className="truncate text-neutral-200">{name}</span>
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          ));
              return parts;
            });
          })()
          )}
          {currentVoidId && currentChannel?.type !== 'kanban' && currentChannel?.type !== 'form' && currentChannel?.type !== 'habit' && currentChannel?.type !== 'voice' && msgs.length === 0 && (
            <div className="text-neutral-500 text-sm">No messages yet</div>
          )}
        </div>

        {/* Typing + presence (desktop view) */}
        <div className="px-4 text-xs text-teal-300 hidden md:block md:mb-2">
          <div className="py-1 min-h-[1.5rem]">
            {renderTypingIndicator()}
          </div>
        </div>

        {/* Voice room or Input (hidden for Kanban/Form/Habit) */}
        {currentChannel?.type !== 'kanban' && currentChannel?.type !== 'form' && currentChannel?.type !== 'habit' && currentChannel?.type !== 'gallery' && currentChannel?.type !== 'notes' && (
          <div className="p-3 md:static fixed inset-x-0 bottom-4 z-20 md:mb-4 bg-transparent pb-[env(safe-area-inset-bottom)]">
          {typingStatus.text && (
            <div className="md:hidden mb-2 text-xs text-teal-300">
              {renderTypingIndicator()}
            </div>
          )}
          {!currentVoidId ? (
            <div className="text-center text-sm text-neutral-400">Create or join a space to start chatting.</div>
          ) : currentChannel?.type === 'voice' ? (
            <div className="flex flex-col gap-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 text-emerald-300 font-semibold">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5"><path d="M11 5a3 3 0 0 1 6 0v7a3 3 0 0 1-6 0Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v3"/></svg>
                  <span>Voice</span>
                </div>
                <div className="text-xs text-neutral-300 inline-flex items-center gap-1 rounded-full border border-neutral-800/80 bg-neutral-900/60 px-2 py-0.5">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-3.5 w-3.5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                  <span>{voiceJoined ? (Object.keys(voicePeers).length + 1) : 0} listening</span>
                </div>
              </div>
              {!voiceJoined ? (
                <div className="flex items-center gap-2">
                  <button className="px-4 py-2 rounded-lg border border-emerald-700 bg-gradient-to-r from-emerald-800/70 to-teal-800/70 hover:from-emerald-700/70 hover:to-teal-700/70 text-emerald-50 shadow-sm inline-flex items-center gap-2" onClick={joinVoice}>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5"><path d="M12 5v14M5 12h14"/></svg>
                    <span>Join Voice</span>
                  </button>
                </div>
              ) : (
                <div className="flex items-center gap-2 flex-wrap rounded-lg border border-neutral-800/70 bg-neutral-900/40 backdrop-blur px-2 py-2">
                  <button className="px-3 py-2 rounded-md border border-neutral-700 text-neutral-200 hover:bg-neutral-800/60 inline-flex items-center gap-1" onClick={toggleMute} title={voiceMuted ? 'Unmute' : 'Mute'}>
                    {voiceMuted ? (
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4 text-red-400"><path d="M13.5 14.5V9.4a3.4 3.4 0 0 0-5.7-2.4L5 9H2v6h3l2.8 2.8a3.4 3.4 0 0 0 5.7-2.4Z"/><path d="m14 9 7-7"/></svg>
                    ) : (
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><path d="M12 3v10"/><path d="M8 7h8"/><path d="M5 10v2a7 7 0 0 0 14 0v-2"/><path d="M12 19v3"/></svg>
                    )}
                    <span className="hidden sm:inline">{voiceMuted ? 'Unmute' : 'Mute'}</span>
                  </button>
                  <button className="px-3 py-2 rounded-md border border-red-800 text-red-300 hover:bg-red-900/30 inline-flex items-center gap-1" onClick={leaveVoice} title="Leave">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><path d="M10 3H3v18h7"/><path d="M21 12H7"/><path d="m14 7 5 5-5 5"/></svg>
                    <span className="hidden sm:inline">Leave</span>
                  </button>
                  <button className="px-3 py-2 rounded-md border border-neutral-700 text-neutral-200 hover:bg-neutral-800/60 inline-flex items-center gap-1" onClick={()=>{ setDevicesOpen(v=>!v); if (!devicesOpen) refreshDevices(); }} title="Devices">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V22a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h0A1.65 1.65 0 0 0 9 2.09V2a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h0a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v0A1.65 1.65 0 0 0 22 12a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>
                    <span className="hidden sm:inline">Devices</span>
                  </button>
                  {needsAudioUnlock && (
                    <button className="px-3 py-2 rounded-md border border-amber-800 text-amber-200 hover:bg-amber-900/30 inline-flex items-center gap-1" onClick={async()=>{
                      try { await audioCtxRef.current?.resume(); } catch {}
                      try {
                        let ok = true;
                        for (const el of audioElsRef.current.values()) {
                          try { const p = el.play(); if (p && typeof (p as any).then === 'function') { await p; } } catch { ok = false; }
                        }
                        if (ok) setNeedsAudioUnlock(false);
                      } catch {}
                    }} title="Enable Audio">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><path d="M11 5v14l-7-4V9z"/><path d="M19 5v14"/></svg>
                      <span className="hidden sm:inline">Enable Audio</span>
                    </button>
                  )}
                  <div className="ml-auto hidden md:flex items-center gap-2 text-xs text-neutral-400">
                    <span>Peers:</span>
                    <span className="truncate max-w-[50vw]">{Object.values(voicePeers).map(p => p.name || 'User').join(', ') || 'None'}</span>
                  </div>
                </div>
              )}
              {voiceJoined && devicesOpen && (
                <div className="flex items-center gap-3 flex-wrap text-sm text-neutral-300">
                  <label className="flex items-center gap-1">Mic:
                    <select className="bg-neutral-950 border border-neutral-800 rounded px-2 py-1 text-neutral-200"
                      value={selectedInputId ?? ''}
                      onChange={async (e)=>{ const id=e.target.value; setSelectedInputId(id); await switchMicrophone(id); }}>
                      {inputs.length===0 ? <option value="">Default</option> : inputs.map(d=> (
                        <option key={d.deviceId} value={d.deviceId}>{d.label || `Mic ${d.deviceId.slice(0,6)}`}</option>
                      ))}
                    </select>
                  </label>
                  {(() => { const hasSink = typeof (HTMLMediaElement.prototype as any).setSinkId === 'function'; return hasSink ? (
                    <label className="flex items-center gap-1">Output:
                      <select className="bg-neutral-950 border border-neutral-800 rounded px-2 py-1 text-neutral-200"
                        value={selectedOutputId ?? ''}
                        onChange={async (e)=>{ const id=e.target.value; setSelectedOutputId(id); await applyOutputDevice(id); }}>
                        {outputs.length===0 ? <option value="">Default</option> : outputs.map(d=> (
                          <option key={d.deviceId} value={d.deviceId}>{d.label || `Device ${d.deviceId.slice(0,6)}`}</option>
                        ))}
                      </select>
                    </label>
                  ) : null; })()}
                </div>
              )}
