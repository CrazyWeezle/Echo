import { useEffect, useRef, useState } from 'react';
import { api, signUpload } from '../lib/api';
import CloseButton from './CloseButton';

export default function ProfileModal({ token, open, onClose, onSaved, onOpenSettings }: { token: string; open: boolean; onClose: () => void; onSaved: (u: any) => void; onOpenSettings?: () => void }) {
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState('');
  const [name, setName] = useState('');
  const [bio, setBio] = useState('');
  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);
  const [bannerUrl, setBannerUrl] = useState<string | null>(null);
  const [status, setStatus] = useState<string>('online');
  const [nameColor, setNameColor] = useState<string>('');
  const [pronouns, setPronouns] = useState<string>('');
  const [website, setWebsite] = useState<string>('');
  const [activity, setActivity] = useState<string>('');
  const [showActivity, setShowActivity] = useState<boolean>(true);
  const [bannerPositionY, setBannerPositionY] = useState<number>(50);
  const [skills, setSkills] = useState<string[]>([]);
  const [skillInput, setSkillInput] = useState('');
  const [pinned, setPinned] = useState<{ title: string; url: string; kind?: string }[]>([]);
  const [socials, setSocials] = useState<{ github?: string; linkedin?: string; notion?: string; twitter?: string; instagram?: string; portfolio?: string }>({});
  // Notification settings moved to Settings modal
  // Friend indicator removed; status ring is used globally
  const [autoSavingBio, setAutoSavingBio] = useState<boolean>(false);
  const lastSavedBioRef = useRef<string>('');
  const bioSaveTimerRef = useRef<number | null>(null);
  const [autoSavingActivity, setAutoSavingActivity] = useState<boolean>(false);
  const actSaveTimerRef = useRef<number | null>(null);

  useEffect(() => {
    if (!open) return;
    setLoading(true); setErr('');
    api.getAuth('/users/me', token)
      .then(u => {
        setName(u.name || '');
        try {
          const draft = localStorage.getItem('profile.bioDraft');
          const initialBio = (draft != null ? draft : (u.bio || ''));
          setBio(initialBio);
          lastSavedBioRef.current = String(u.bio || '');
        } catch {
          setBio(u.bio || '');
          lastSavedBioRef.current = String(u.bio || '');
        }
        setAvatarUrl(u.avatarUrl || null);
        setBannerUrl(u.bannerUrl || (()=>{ try { return localStorage.getItem('profile.bannerUrl') || null; } catch { return null; } })());
        setStatus(u.status || 'online');
        setNameColor(u.nameColor || '');
        setPronouns(u.pronouns || '');
        setWebsite(u.website || '');
        setActivity(u.activity || (()=>{ try { return localStorage.getItem('profile.activity') || ''; } catch { return ''; } })());
        setShowActivity(typeof u.showActivity === 'boolean' ? !!u.showActivity : (()=>{ try { const v = localStorage.getItem('profile.showActivity'); return v == null ? true : v !== '0'; } catch { return true; } })());
        try { const p = localStorage.getItem('profile.bannerPositionY'); const n = u.bannerPositionY ?? (p!=null ? Number(p) : 50); setBannerPositionY(Number.isFinite(n) ? Math.max(0, Math.min(100, n)) : 50); } catch { setBannerPositionY(50); }
        try { const s = u.skills ?? JSON.parse(localStorage.getItem('profile.skills')||'[]'); if (Array.isArray(s)) setSkills(s.filter((x:any)=>typeof x==='string')); } catch {}
        try { const pr = u.pinned ?? JSON.parse(localStorage.getItem('profile.pinned')||'[]'); if (Array.isArray(pr)) setPinned(pr.filter((it:any)=>it && typeof it.title==='string' && typeof it.url==='string')); } catch {}
        try { const so = u.socials ?? JSON.parse(localStorage.getItem('profile.socials')||'{}'); if (so && typeof so==='object') setSocials(so); } catch {}
      })
      .catch((e: any) => setErr(e.message || 'Failed to load profile'))
      .finally(() => setLoading(false));
  }, [open, token]);

  // Autosave bio (debounced). Also persist a local draft for safety.
  useEffect(() => {
    if (!open) return;
    const t = setTimeout(async () => {
      try {
        const b = String(bio ?? '');
        // Update local draft so reopening keeps content even if the modal is closed
        try {
          if (b.trim()) localStorage.setItem('profile.bioDraft', b); else localStorage.removeItem('profile.bioDraft');
        } catch {}
        // Avoid sending if unchanged from last known saved value
        if (b === lastSavedBioRef.current) return;
        setAutoSavingBio(true);
        await api.patchAuth('/users/me', { bio: b }, token);
        lastSavedBioRef.current = b;
      } catch {
        // keep draft; will retry on next change/open
      } finally {
        setAutoSavingBio(false);
      }
    }, 800) as unknown as number;
    bioSaveTimerRef.current = t;
    return () => { if (bioSaveTimerRef.current) { clearTimeout(bioSaveTimerRef.current); bioSaveTimerRef.current = null; } };
  }, [bio, open, token]);

  // Autosave activity (debounced) and keep a local copy so People list can show it
  useEffect(() => {
    if (!open) return;
    const t = setTimeout(async () => {
      try {
        const a = String(activity || '');
        try { localStorage.setItem('profile.activity', a); } catch {}
        setAutoSavingActivity(true);
        await api.patchAuth('/users/me', { activity: a, showActivity }, token);
      } catch {
      } finally {
        setAutoSavingActivity(false);
      }
    }, 800) as unknown as number;
    actSaveTimerRef.current = t;
    return () => { if (actSaveTimerRef.current) { clearTimeout(actSaveTimerRef.current); actSaveTimerRef.current = null; } };
  }, [activity, showActivity, open, token]);

  // Immediate flush helper for critical moments (close/blur/unload)
  async function flushBioNowIfDirty(reason?: string) {
    const b = String(bio ?? '');
    if (!open) return; // only when modal open
    if (b === lastSavedBioRef.current) return;
    try {
      setAutoSavingBio(true);
      // Use keepalive to improve success during unload
      await fetch('/api/users/me', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ bio: b }),
        keepalive: true,
      } as RequestInit);
      lastSavedBioRef.current = b;
      try { localStorage.setItem('profile.bioDraft', b); } catch {}
    } catch {}
    finally { setAutoSavingBio(false); }
  }

  // Save on blur/visibility change/unload to avoid losing recent text
  useEffect(() => {
    if (!open) return;
    const onVis = () => { if (document.hidden) { flushBioNowIfDirty('vis'); } };
    const onBeforeUnload = () => { flushBioNowIfDirty('unload'); };
    document.addEventListener('visibilitychange', onVis);
    window.addEventListener('beforeunload', onBeforeUnload);
    return () => {
      document.removeEventListener('visibilitychange', onVis);
      window.removeEventListener('beforeunload', onBeforeUnload);
    };
  }, [open, bio, token]);

  // If modal closes without pressing Save, flush latest bio
  useEffect(() => {
    if (!open) return () => {};
    return () => { flushBioNowIfDirty('close'); };
  }, [open]);

  async function onAvatarPick(files: FileList | null) {
    if (!files || files.length === 0) return;
    const f = files[0];
    try {
      const { url, headers, publicUrl } = await signUpload({ filename: f.name, contentType: f.type || 'application/octet-stream', size: f.size }, token);
      await fetch(url, { method: 'PUT', headers, body: f });
      setAvatarUrl(publicUrl);
    } catch (e) {
      console.error(e);
      setErr('Upload failed');
    }
  }

  async function onBannerPick(files: FileList | null) {
    if (!files || files.length === 0) return;
    const f = files[0];
    try {
      const { url, headers, publicUrl } = await signUpload({ filename: f.name, contentType: f.type || 'application/octet-stream', size: f.size }, token);
      await fetch(url, { method: 'PUT', headers, body: f });
      setBannerUrl(publicUrl);
    } catch (e) {
      console.error(e);
      setErr('Upload failed');
    }
  }

  async function save() {
    setLoading(true); setErr('');
    try {
      const payload: any = { name, bio, avatarUrl, bannerUrl, bannerPositionY, status, pronouns, website, activity, showActivity, skills, pinned, socials };
      const c = String(nameColor || '').trim();
      payload.nameColor = c ? c : null;
      const u = await api.patchAuth('/users/me', payload, token);
      try { localStorage.removeItem('profile.bioDraft'); } catch {}
      try {
        if (bannerUrl != null) localStorage.setItem('profile.bannerUrl', bannerUrl);
        else localStorage.removeItem('profile.bannerUrl');
        localStorage.setItem('profile.activity', activity || '');
        localStorage.setItem('profile.showActivity', showActivity ? '1' : '0');
        localStorage.setItem('profile.bannerPositionY', String(bannerPositionY));
        localStorage.setItem('profile.skills', JSON.stringify(skills));
        localStorage.setItem('profile.pinned', JSON.stringify(pinned));
        localStorage.setItem('profile.socials', JSON.stringify(socials));
      } catch {}
      onSaved(u);
      onClose();
    } catch (e: any) {
      setErr(e.message || 'Failed to save');
    } finally {
      setLoading(false);
    }
  }

  // close on Escape
  useEffect(() => {
    if (!open) return;
    const onKey = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [open, onClose]);

  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />
      <div className="relative w-[calc(100%-1rem)] sm:w-full max-w-md max-h-[88vh] overflow-auto rounded-xl border border-neutral-800 bg-neutral-900 p-0 shadow-xl">
        {/* Banner */}
        <div className="relative h-28 sm:h-32 w-full rounded-t-xl overflow-hidden border-b border-neutral-800">
          {bannerUrl ? (
            <img src={bannerUrl} alt="banner" className="h-full w-full object-cover" style={{ objectPosition: `center ${bannerPositionY}%` }} />
          ) : (
            <div className="h-full w-full brand-login-bg opacity-80" />
          )}
          <button className="absolute top-2 right-2 text-neutral-300 hover:text-neutral-100 bg-neutral-900/50 rounded px-2 py-1 border border-neutral-700" onClick={onClose} aria-label="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4">
              <line x1="18" y1="6" x2="6" y2="18" />
