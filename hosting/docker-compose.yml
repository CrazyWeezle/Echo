name: ECHO

services:
  api:
    build:
      context: ..
      dockerfile: hosting/Dockerfile.api
    container_name: echo-api
    env_file:
      - env/api.env
      - env/minio.env
    environment:
      # Optional: if your API expects PORT
      PORT: "5000"
      # S3 client endpoint for signing happens inside API; rely on env/minio.env (http://minio:9000)
      # Public base for downloaded files used in message attachments (served by Nginx)
      STORAGE_PUBLIC_BASE: "/files/echo-app"
      # SMTP + App URL are read from env/api.env in production.
      # Edit hosting/env/api.env and set:
      #   SMTP_HOST=your-smtp-host
      #   SMTP_PORT=587            # or 465
      #   SMTP_SECURE=false        # true only for port 465
      #   SMTP_USER=your-smtp-username
      #   SMTP_PASS=your-smtp-password
      #   FROM_EMAIL=no-reply@your-domain.com
      #   PUBLIC_WEB_URL=https://app.your-domain.com
    ports:
      - "5000:5000"   # you can remove this later if you want API private
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:5000/api/health"]
      interval: 10s
      timeout: 3s
      retries: 20
      start_period: 10s
    restart: unless-stopped

  web:
    build:
      context: ..
      dockerfile: hosting/Dockerfile.web
      args:
        VITE_API_URL: "/api"
    container_name: echo-web
    ports:
      - "3000:80"
    env_file:
      - env/web.env
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: echo-cloudflared
    # Token mode via Compose .env (hosting/.env)
    # Put TUNNEL_TOKEN=eyJ... in hosting/.env
    command: ["tunnel","--no-autoupdate","run","--token","${TUNNEL_TOKEN}"]
    depends_on:
      web:
        condition: service_started
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    container_name: echo-postgres
    environment:
      POSTGRES_USER: echo
      POSTGRES_PASSWORD: echo
      POSTGRES_DB: echo
    ports:
      - "5432:5432"   # optional, for local tools (psql/GUI). Remove for prod.
    volumes:
      - echo_pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 10s
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    container_name: echo-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    env_file:
      - env/minio.env
    volumes:
      - echo_minio_data:/data
    restart: unless-stopped

  minio-mc:
    image: minio/mc:latest
    container_name: echo-minio-mc
    depends_on:
      - minio
    env_file:
      - env/minio.env
    entrypoint:
      - /bin/sh
      - -c
      - |
          i=0;
          until /usr/bin/mc alias set local http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD}; do
            i=$$((i+1)); echo 'Waiting for MinIO...'; sleep 2;
            if [ $$i -gt 60 ]; then echo 'Timeout waiting for MinIO'; exit 1; fi;
          done;
          /usr/bin/mc mb -p local/$${S3_BUCKET} || true
          /usr/bin/mc anonymous set download local/$${S3_BUCKET} || true
          /usr/bin/mc admin config set local api \
            cors_allow_origin='http://localhost:3000,http://localhost:5173,https://app.echologin.org' \
            cors_allow_methods='GET,PUT,HEAD,OPTIONS' \
            cors_allow_headers='*' || true
          /usr/bin/mc admin service restart local || true
          echo 'MinIO bucket ready'
    restart: on-failure

  mailhog:
    image: mailhog/mailhog:latest
    container_name: echo-mailhog
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI at http://localhost:8025
    restart: unless-stopped

  adminer:
    image: adminer:latest
    container_name: echo-adminer
    environment:
      ADMINER_DEFAULT_SERVER: db
    ports:
      - "8080:8080"  # visit http://localhost:8080
    depends_on:
      - db
    restart: unless-stopped

volumes:
  echo_pg_data:
  echo_minio_data:
