server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # HTTP API
    location /api/ {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Connection "";
        proxy_pass http://api:5000;   # keep /api prefix
    }

    # Proxy S3/MinIO bucket via same-origin path for browser access and uploads
    # Example public URL: /files/echo-app/<key>
    # Use ^~ to ensure this prefix location wins over regex static asset rules below
    location ^~ /files/ {
        # Allow large uploads
        client_max_body_size 50m;
        proxy_http_version 1.1;
        proxy_request_buffering off;  # stream uploads
        proxy_buffering off;
        # Preserve host used in SigV4 (minio upstream host:port)
        proxy_set_header Host $proxy_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Connection "";
        # Pass through common x-amz query values as headers (harmless, some proxies expect them)
        proxy_set_header x-amz-content-sha256 $arg_X_Amz_Content_Sha256;
        proxy_set_header x-amz-sdk-checksum-algorithm $arg_x_amz_sdk_checksum_algorithm;
        proxy_set_header x-amz-checksum-crc32 $arg_x_amz_checksum_crc32;
        # Important: trailing slash strips the /files prefix when proxying
        proxy_pass http://minio:9000/;
    }

    # ðŸ”§ Socket.IO (WebSocket + polling) proxy
    # Cloudflare Tunnel and various proxies can occasionally drop idle connections.
    # Use longer timeouts and disable buffering to keep WS robust.
    location /socket.io/ {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
        proxy_buffering off;
        proxy_pass http://api:5000;
    }

    # Long-term caching for static assets emitted by Vite build
    location ~* \.(?:js|css|png|svg|webp|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        try_files $uri =404;
    }

    # SPA fallback
    location / {
        try_files $uri /index.html;
    }
}
