# ---------- builder ----------
FROM node:20-alpine AS builder
WORKDIR /repo
RUN corepack enable && corepack prepare pnpm@10.19.0 --activate

# Build args for Vite
ARG VITE_API_URL=/api
ENV VITE_API_URL=$VITE_API_URL
# (optional: keep backward compat with older var name)
ENV VITE_API_HTTP_URL=$VITE_API_URL

# Optional: GIF provider API key for GifPicker
# Pass via docker-compose build arg; value is baked at build time
ARG VITE_GIPHY_KEY
ENV VITE_GIPHY_KEY=$VITE_GIPHY_KEY
ARG VITE_VAPID_PUBLIC_KEY
ENV VITE_VAPID_PUBLIC_KEY=$VITE_VAPID_PUBLIC_KEY
ARG VITE_DISABLE_PWA
ENV VITE_DISABLE_PWA=$VITE_DISABLE_PWA

COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY apps/web/package.json apps/web/package.json
# Install only the web workspace (include devDependencies to build)
RUN pnpm install --filter ./apps/web --no-frozen-lockfile

COPY . .
WORKDIR /repo/apps/web
# Sanity: print a small slice of MemberProfileModal and App to confirm builder sees source (harmless in logs)
RUN echo '--- MemberProfileModal.tsx (320-360) ---' && sed -n '320,360p' src/components/MemberProfileModal.tsx || true \
 && echo '--- App.tsx (1-40) ---' && sed -n '1,40p' src/App.tsx || true
# Vite will read VITE_* from env at build-time
# Use the package script to avoid PATH quirks
RUN pnpm run build

# ---------- runtime ----------
FROM nginx:alpine AS runtime
COPY --from=builder /repo/apps/web/dist /usr/share/nginx/html
# Nginx reverse proxy to API
COPY hosting/nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
